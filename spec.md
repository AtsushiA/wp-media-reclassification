# WordPressのプラグインの仕様

## 基本機能

- WordPress メディアファイルの設定 "Organize my uploads into month- and year-based folders" が無効になってファイルをアップロードされている場合を想定
- WordPress メディアに登録されている日時を元に メディアディアファイルのディレクトリ 年/月 のフォルダに実ファイルを移動
  - メディアに登録されているDB情報をアップデートする
  - メディアを使用している記事のパスを更新する
- メディアファイルのディレクトリは "upload_path" もしくは wp-config.php での値を取得する
- WordPressの設定、データベースへの接続の確認は wp-config.php を参照する
- 管理画面からは実行する場合は対象のファイル数が参照できる、実行も可能
- wp-cli からも実行できるようにしたい

## サムネイル画像の取り扱い

- WordPressが自動生成するサムネイル画像（複数サイズ）も移動対象とする
- サムネイルファイル名パターン: `image-150x150.jpg`, `image-300x300.jpg` など
- `_wp_attachment_metadata` メタデータ内のパス情報も更新する

## エラーハンドリング・例外処理

- ファイル移動失敗時の処理（権限エラー、ディスク容量不足など）
  - エラーログを記録し、処理を継続（スキップ）
- 移動先ディレクトリが作成できない場合
  - エラーを記録し、該当ファイルの処理をスキップ
- データベース更新失敗時の対処
  - ファイルは移動済み、DB更新失敗のケースを記録
  - 手動修正が必要な項目としてリスト化
- ロールバック方針
  - 全体のロールバックは行わず、個別エラーを記録・報告

## 実行モード・安全性

- ドライラン（テスト実行）モード
  - 実際にファイルを移動せず、移動対象と移動先を表示
- バッチ処理
  - 一度に処理する件数を設定可能（デフォルト: 50件）
- 処理の再開
  - 中断時は次回実行時に未処理分から継続可能
- 既存の年/月フォルダ内ファイルの扱い
  - 既に正しいフォルダ構造にあるファイルはスキップ

## ファイル名の重複処理

- 移動先に同名ファイルが存在する場合
  - ファイル名に連番を付加してリネーム（例: `image-1.jpg`, `image-2.jpg`）
  - 重複を検出した場合はログに記録

## ログ・進捗管理

- 処理ログの記録
  - 成功: ファイルパス、移動元、移動先
  - 失敗: ファイルパス、エラー内容
- 管理画面での進捗表示
  - プログレスバーで処理状況を表示
  - 処理済み件数 / 全体件数
- エラーファイルのリスト表示
  - 管理画面で確認可能

## 対象メディアの絞り込み

- 基本的に全メディアタイプを対象
  - 画像、動画、PDF、その他ファイル
- フィルター条件
  - 特定の日付範囲で絞り込み可能
  - 添付ファイルのステータス（inherit, private など）は問わず処理

## 記事内容の更新詳細

- 更新対象コンテンツ
  - 投稿本文（post_content）
  - 固定ページ本文
  - カスタムフィールド（post_meta）
  - ※ウィジェット、カスタマイザー設定は対象外
- 検索・置換方法
  - 旧パスから新パスへの文字列置換
  - ショートコード内のパスも更新

## パフォーマンス・リソース管理

- タイムアウト対策
  - バッチ処理で分割実行
  - WP-CLIでの実行を推奨（大量ファイル時）
- メモリ使用量
  - 一度に大量のデータを読み込まない設計
- 実行時間制限
  - `set_time_limit()` で適切に調整

## バックアップ・復元

- 実行前の推奨事項
  - 管理画面で「事前にバックアップを取ることを推奨」と表示
  - データベースとファイルのバックアップ推奨メッセージ
- 元に戻す機能
  - 初版では実装しない（手動でのリストア対応）

## 権限・セキュリティ

- 管理画面での実行権限
  - 管理者（administrator）のみ実行可能
- WP-CLI実行権限
  - サーバーアクセス権限を持つユーザー
- セキュリティ対策
  - nonce検証を実施
  - 権限チェック（current_user_can）

## 日付の取得元

- メディアの登録日時として `post_date` を使用
- タイムゾーン
  - WordPressのタイムゾーン設定（get_option('timezone_string')）に従う

## UI/UX詳細

- 管理画面のメニュー配置
  - 「ツール」メニュー配下に「メディア再分類」を追加
- 実行確認ダイアログ
  - 「◯◯件のファイルを移動します。実行してよろしいですか？」
- 処理完了メッセージ
  - 「◯◯件の処理が完了しました。（成功: ◯◯件、エラー: ◯◯件）」
- WP-CLIコマンド
  - コマンド名: `wp media reclassify`
  - オプション: `--dry-run`, `--batch-size=N`, `--date-from=YYYY-MM-DD`, `--date-to=YYYY-MM-DD`

## マルチサイト対応

- 初版では非対応
- 各サイトごとに個別実行が必要

## その他の考慮事項

- 既存の年/月フォルダ構造との整合性
  - 一部のファイルが既にフォルダ分けされている場合も正常動作
  - 重複チェックを行い、適切に処理
